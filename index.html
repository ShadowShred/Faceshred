<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Easy Face Blur — Web</title>
  <style>
    :root { --gap:12px; --bg:#0b1020; --card:#111a30; --text:#e8eefc; --muted:#9fb0d1; --brand:#4a6bff; --bar:#101831; --accent:#50c8ff; --accent2:#ff6fa5; }
    html, body { margin:0; padding:0; height:100%; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    header { padding:14px 16px; border-bottom:1px solid #1d2745; display:flex; align-items:center; gap:10px; }
    header h1 { margin:0; font-size:16px; font-weight:800; letter-spacing:0.2px; }

    .app { display:grid; grid-template-columns:360px 1fr; gap:var(--gap); padding:var(--gap); }
    @media (max-width: 900px) { .app { grid-template-columns:1fr; padding-bottom:76px; } }

    .panel { background:var(--card); border:1px solid #1d2745; border-radius:16px; padding:14px; box-shadow:0 0 0 1px #0a1024 inset, 0 8px 24px rgba(0,0,0,0.35); }
    .panel h2 { margin:0 0 10px; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:0.8px; }
    .controls { display:flex; flex-direction:column; gap:10px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .btn { appearance:none; border:1px solid #2b3d77; background:#16224a; color:var(--text); padding:12px 14px; border-radius:12px; cursor:pointer; font-weight:700; }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }
    .btn.primary { background:var(--brand); border-color:#2e48e6; }
    .seg { display:inline-flex; border:1px solid #2b3d77; border-radius:12px; overflow:hidden; }
    .seg button { background:#16224a; border:0; padding:10px 12px; color:var(--muted); font-weight:700; }
    .seg button.on { background:var(--brand); color:white; }

    #facesList { max-height:200px; overflow:auto; border:1px dashed #29406f; border-radius:12px; padding:8px; }
    #facesList .item { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 8px; border-bottom:1px dashed #1f2a48; }
    #facesList .item:last-child { border-bottom:none; }

    .stage { position:relative; width:100%; background:#0b0f1f; border:1px solid #1f2842; border-radius:16px; overflow:hidden; }
    canvas { max-width:100%; height:auto; display:block; }
    #overlay { position:absolute; left:0; top:0; pointer-events:auto; }

    .legend { display:flex; gap:16px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:20px; background:#0f1a36; border:1px solid #223055; font-size:12px; color:var(--muted); }
    .chip .swatch { width:10px; height:10px; border-radius:50%; display:inline-block; background:var(--accent); }
    .chip .swatch2 { background:var(--accent2); }
    .tip { margin-top:8px; color:var(--muted); }

    .bar { position:fixed; left:0; right:0; bottom:0; background:var(--bar); border-top:1px solid #1d2745; padding:10px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left); display:none; gap:8px; }
    .bar .btn { flex:1 1 auto; padding:12px; }
    @media (max-width: 900px) { .bar { display:flex; } }
  </style>
  <!-- Web-only (no PWA/service worker). Scripts load last for reliability. -->
</head>
<body>
  <header><h1>Easy Face Blur — Web</h1></header>

  <div class="app">
    <section class="panel">
      <h2>Controls</h2>
      <div class="controls">
        <input id="fileInput" class="btn" type="file" accept="image/*" />
        <div class="row">
          <button id="detectBtn" class="btn" disabled>Detect Faces</button>
          <button id="selectAllBtn" class="btn" disabled>Select All</button>
          <button id="clearSelBtn" class="btn" disabled>Clear Selection</button>
        </div>
        <div class="row">
          <label>Blur radius <input id="blurRadius" class="btn" type="number" min="1" max="80" value="22" style="width:92px; padding:10px;" /></label>
          <label>Expand box % <input id="boxPad" class="btn" type="number" min="0" max="80" value="20" style="width:92px; padding:10px;" /></label>
        </div>
        <div class="row">
          <span class="tip">Mode:</span>
          <div class="seg">
            <button id="modeBlur" class="on" type="button">Blur</button>
            <button id="modePix" type="button">Pixelate</button>
          </div>
        </div>
        <div class="row">
          <button id="applyBtn" class="btn primary" disabled>Apply</button>
          <button id="undoBtn" class="btn" disabled>Undo</button>
          <button id="redoBtn" class="btn" disabled>Redo</button>
          <button id="resetBtn" class="btn" disabled>Reset</button>
          <button id="downloadBtn" class="btn" disabled>Download</button>
        </div>
        <div class="legend">
          <span class="chip"><span class="swatch"></span> Detected</span>
          <span class="chip"><span class="swatch swatch2"></span> Selected</span>
        </div>
        <div class="tip">Tap a box to toggle. On mobile, use the bottom bar for quick actions.</div>
      </div>
    </section>

    <section class="panel">
      <h2>Image</h2>
      <div class="stage">
        <canvas id="canvas"></canvas>
        <canvas id="overlay"></canvas>
      </div>
    </section>
  </div>

  <div class="bar">
    <button id="barApply" class="btn primary" disabled>Apply</button>
    <button id="barUndo" class="btn" disabled>Undo</button>
    <button id="barRedo" class="btn" disabled>Redo</button>
    <button id="barReset" class="btn" disabled>Reset</button>
  </div>

  <!-- Load libs, then app, at the end so DOM is ready -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.13.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
  <script>
  'use strict';

  // ===== App state & elements =====
  const S={ image:null, detections:[], scale:1, history:[], redo:[], original:null, mode:'blur' };
  const $=id=>document.getElementById(id);
  const fileInput=$('fileInput'), detectBtn=$('detectBtn'), selectAllBtn=$('selectAllBtn'), clearSelBtn=$('clearSelBtn');
  const applyBtn=$('applyBtn'), undoBtn=$('undoBtn'), redoBtn=$('redoBtn'), resetBtn=$('resetBtn'), downloadBtn=$('downloadBtn');
  const barApply=$('barApply'), barUndo=$('barUndo'), barRedo=$('barRedo'), barReset=$('barReset');
  const blurRadius=$('blurRadius'), boxPad=$('boxPad');
  const modeBlur=$('modeBlur'), modePix=$('modePix');
  const facesList=(function(){ const d=document.createElement('div'); d.id='facesList'; return d; })(); // placeholder created if missing
  const canvas=$('canvas'), overlay=$('overlay');
  const ctx=canvas.getContext('2d');
  const octx=overlay.getContext('2d');

  function setEnabled(el,on){ if(el) el.disabled=!on; }
  function canUndo(){ return S.history.length>0 }
  function canRedo(){ return S.redo.length>0 }
  function pushHistory(){ try{ S.history.push(ctx.getImageData(0,0,canvas.width,canvas.height)); S.redo=[] }catch(e){} }

  function refresh(){
    const has=!!S.image; setEnabled(detectBtn,has); setEnabled(selectAllBtn,S.detections.length>0); setEnabled(clearSelBtn,S.detections.some(d=>d.selected));
    const sel=S.detections.some(d=>d.selected); setEnabled(applyBtn,sel); setEnabled(downloadBtn,has); setEnabled(undoBtn,canUndo()); setEnabled(redoBtn,canRedo()); setEnabled(resetBtn,has);
    setEnabled(barApply,sel); setEnabled(barUndo,canUndo()); setEnabled(barRedo,canRedo()); setEnabled(barReset,has);
  }

  function fitCanvas(img){
    const maxW = (window.innerWidth<900? 1400: 2400);
    const scale = Math.min(1, maxW / img.width);
    const w=Math.round(img.width*scale), h=Math.round(img.height*scale);
    canvas.width=w; canvas.height=h; overlay.width=w; overlay.height=h; S.scale=scale;
    ctx.clearRect(0,0,w,h); ctx.drawImage(img,0,0,w,h);
    S.history=[]; S.redo=[]; try{ S.original=ctx.getImageData(0,0,w,h) }catch{}
    drawBoxes(); refresh();
  }

  function drawBoxes(){
    octx.clearRect(0,0,overlay.width,overlay.height);
    for(const [i,det] of S.detections.entries()){
      const {x,y,w,h}=det.box; octx.lineWidth=2; octx.strokeStyle=det.selected?'#ff6fa5':'#50c8ff'; octx.fillStyle=det.selected?'rgba(255,111,165,0.15)':'rgba(80,200,255,0.12)';
      octx.beginPath(); octx.rect(x,y,w,h); octx.fill(); octx.stroke(); octx.font='12px ui-sans-serif, system-ui, -apple-system'; octx.fillStyle='#cfe3ff'; octx.fillText(`#${i+1}`, x+6, y+16);
    }
    refresh();
  }

  function hit(px,py,b){ return px>=b.x && py>=b.y && px<=b.x+b.w && py<=b.y+b.h }
  function list(){ const listEl=document.getElementById('facesList')||facesList; if(!S.detections.length){ listEl.textContent='No faces detected yet.'; return; } listEl.innerHTML='';
    S.detections.forEach((d,i)=>{ const row=document.createElement('div'); row.className='item'; const left=document.createElement('div'); left.textContent=`Face #${i+1} — ${Math.round(d.box.w)}×${Math.round(d.box.h)} px`;
      const right=document.createElement('div'); const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!d.selected; cb.addEventListener('change',()=>{ d.selected=cb.checked; drawBoxes(); }); right.append(cb); row.append(left,right); listEl.append(row); }); }

  const supportFilter = (()=>{ const c=document.createElement('canvas'); const g=c.getContext('2d'); try{ g.filter='blur(1px)'; return g.filter.includes('blur'); }catch{ return false } })();
  function applyEffectToBox(det){
    const {x,y,w,h}=det.box; const off=document.createElement('canvas'); off.width=Math.max(1,Math.floor(w)); off.height=Math.max(1,Math.floor(h));
    const offctx=off.getContext('2d',{willReadFrequently:true}); offctx.drawImage(canvas,x,y,w,h,0,0,off.width,off.height);
    if (S.mode==='blur' && supportFilter){ offctx.filter=`blur(${Math.max(1,Math.min(80,parseInt(blurRadius.value||'22',10)))}px)`; offctx.drawImage(off,0,0); }
    else { const factor=10; const sw=Math.max(1,Math.floor(off.width/factor)), sh=Math.max(1,Math.floor(off.height/factor)); const tiny=document.createElement('canvas'); tiny.width=sw; tiny.height=sh; const tctx=tiny.getContext('2d'); tctx.imageSmoothingEnabled=false; offctx.imageSmoothingEnabled=false; ctx.imageSmoothingEnabled=false; tctx.drawImage(off,0,0,sw,sh); offctx.clearRect(0,0,off.width,off.height); offctx.drawImage(tiny,0,0,sw,sh,0,0,off.width,off.height); }
    ctx.drawImage(off,x,y,w,h);
  }

  // ===== Handlers =====
  fileInput.addEventListener('change', e=>{
    const file=e.target.files?.[0]; if(!file||!file.type.startsWith('image/')){ alert('Please choose an image file.'); return; }
    const img=new Image(); img.onload=()=>{ S.image=img; S.detections=[]; fitCanvas(img); const c=document.getElementById('facesList'); if(c) c.textContent='Image loaded. Tap Detect Faces.'; refresh(); URL.revokeObjectURL(img.src) }; img.onerror=()=>alert('Could not load that image.'); img.src=URL.createObjectURL(file);
  });

  async function loadModelsOnce(){ if(loadModelsOnce._done) return; const bases=[ 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/', 'https://unpkg.com/@vladmandic/face-api@latest/model/' ]; let ok=false; for(const b of bases){ try{ await faceapi.nets.tinyFaceDetector.loadFromUri(b); ok=true; break; }catch(e){ console.warn('model load failed from',b,e);} } if(!ok) throw new Error('Could not load models'); loadModelsOnce._done=true; }

  // Detect faces with simple fallbacks
  detectBtn.addEventListener('click', async()=>{
    if(!S.image) return; const listEl=document.getElementById('facesList')||facesList; listEl.textContent='Detecting faces…';
    try{ await loadModelsOnce(); }catch(e){ listEl.textContent='Could not load model files.'; return; }
    const mobile = window.innerWidth < 900; let opts = new faceapi.TinyFaceDetectorOptions({ inputSize: mobile?416:608, scoreThreshold: mobile?0.3:0.25 });
    let dets = [];
    try{ dets = await faceapi.detectAllFaces(canvas, opts);}catch(e){ console.warn(e); }
    if(!dets.length){ opts = new faceapi.TinyFaceDetectorOptions({ inputSize: mobile?512:768, scoreThreshold: 0.18 }); try{ dets = await faceapi.detectAllFaces(canvas, opts);}catch(e){} }
    if(!dets.length){ try{ dets = await faceapi.detectAllFaces(S.image, opts);}catch(e){} }
    if(!dets.length){ try{ const base=(loadModelsOnce._done && typeof loadModelsOnce._done==='string')?loadModelsOnce._done:'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/'; if(!faceapi.nets.ssdMobilenetv1 || !faceapi.nets.ssdMobilenetv1.params){ await faceapi.nets.ssdMobilenetv1.loadFromUri(base);} const ssd = new faceapi.SsdMobilenetv1Options({ minConfidence:0.2, maxResults:50 }); dets = await faceapi.detectAllFaces(canvas, ssd);}catch(e){}}

    if(!dets.length){ listEl.textContent='No faces detected. Try better lighting/angle or use Select All and Apply to blur everything after dragging boxes (coming soon).'; S.detections=[]; drawBoxes(); return; }

    const pad=parseInt(boxPad.value||'0',10)/100; S.detections=dets.map(d=>{ const {x,y,width,height}=d.box; const dx=width*pad, dy=height*pad; const bx=Math.max(0,x-dx), by=Math.max(0,y-dy); const bw=Math.min(canvas.width-bx,width+2*dx); const bh=Math.min(canvas.height-by,height+2*dy); return { box:{x:bx,y:by,w:bw,h:bh}, selected:true } });
    drawBoxes(); list();
  });

  selectAllBtn.addEventListener('click', ()=>{ S.detections.forEach(d=>d.selected=true); drawBoxes(); list(); });
  clearSelBtn.addEventListener('click', ()=>{ S.detections.forEach(d=>d.selected=false); drawBoxes(); list(); });
  overlay.addEventListener('click', ev=>{ if(!S.detections.length) return; const r=overlay.getBoundingClientRect(); const sx=overlay.width/r.width, sy=overlay.height/r.height; const x=(ev.clientX-r.left)*sx, y=(ev.clientY-r.top)*sy; const h=S.detections.find(d=>hit(x,y,d.box)); if(h){ h.selected=!h.selected; drawBoxes(); list(); } });

  function applyAll(){ if(!S.image) return; pushHistory(); S.detections.forEach(d=>{ if(d.selected) applyEffectToBox(d); }); drawBoxes(); }
  applyBtn.addEventListener('click', applyAll); barApply.addEventListener('click', applyAll);

  undoBtn.addEventListener('click', ()=>{ if(!canUndo())return; try{ const prev=S.history.pop(); S.redo.push(ctx.getImageData(0,0,canvas.width,canvas.height)); if(canvas.width!==prev.width||canvas.height!==prev.height){ canvas.width=prev.width; canvas.height=prev.height; overlay.width=prev.width; overlay.height=prev.height;} ctx.putImageData(prev,0,0); drawBoxes(); }catch{} });
  redoBtn.addEventListener('click', ()=>{ if(!canRedo())return; try{ const next=S.redo.pop(); S.history.push(ctx.getImageData(0,0,canvas.width,canvas.height)); if(canvas.width!==next.width||canvas.height!==next.height){ canvas.width=next.width; canvas.height=next.height; overlay.width=next.width; overlay.height=next.height;} ctx.putImageData(next,0,0); drawBoxes(); }catch{} });
  barUndo.addEventListener('click', ()=>undoBtn.click()); barRedo.addEventListener('click', ()=>redoBtn.click());

  function resetAll(){ if(!S.image) return; fitCanvas(S.image); S.detections=[]; const c=document.getElementById('facesList'); if(c) c.textContent='Image reset. Tap Detect Faces.'; list(); refresh(); }
  resetBtn.addEventListener('click', resetAll); barReset.addEventListener('click', resetAll);

  downloadBtn.addEventListener('click', ()=>{ const a=document.createElement('a'); a.download='face-blurred.png'; a.href=canvas.toDataURL('image/png'); a.click(); });

  modeBlur.addEventListener('click', ()=>{ S.mode='blur'; modeBlur.classList.add('on'); modePix.classList.remove('on'); });
  modePix.addEventListener('click', ()=>{ S.mode='pixel'; modePix.classList.add('on'); modeBlur.classList.remove('on'); });

  // ===== Hidden Tests (web only) =====
  function assert(name, cond){ if(!cond) throw new Error('FAIL: ' + name); console.log('PASS:', name); }
  function runTests(){ try{
    console.log('--- tests start ---');
    assert('hit inside', hit(5,5,{x:0,y:0,w:10,h:10})===true);
    assert('hit outside', hit(11,5,{x:0,y:0,w:10,h:10})===false);
    canvas.width=20; canvas.height=20; overlay.width=20; overlay.height=20; ctx.fillStyle='#000'; ctx.fillRect(0,0,20,20); pushHistory(); ctx.fillStyle='#fff'; ctx.fillRect(0,0,5,5); assert('canUndo', canUndo()); undoBtn.click(); assert('undo applied', ctx.getImageData(0,0,1,1).data[0]===0);
    console.log('--- tests passed ---');
  }catch(e){ console.error(e); alert(e.message); } }
  window.addEventListener('keydown', e=>{ const isMac=/Mac|iPhone|iPad/.test(navigator.platform); const ctrl=isMac?e.metaKey:e.ctrlKey; if(ctrl && e.altKey && e.key.toLowerCase()==='t'){ e.preventDefault(); runTests(); } });

  refresh();
  </script>
</body>
</html>
